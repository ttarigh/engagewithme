<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Engage with Me</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: left;
        padding: 50px;
      }

      #unlockedImage {
        display: none;
      }
      #measured {
        display: none;
      }
      #imageButton {
        width: 30vw;
        height: 30%;
        cursor: pointer;
      }
      #laced {
        font-family: Arial, sans-serif;
        font-size: 50px;
        color: white;
      }
    </style>
  </head>
  <body>
    <h1>Engage With Me: A Selfie as an Experience</h1>
    <h2>Complete the tasks to engage with my selfie.</h2>
    <button id="startButton" onclick="startButton()">Deep breath...</button>

    <div id="step1" style="display: none">
      <p>Sit in silence for 30 seconds...</p>
      <button id="measure" onclick="step1()">
        I feel like it's been 30 seconds
      </button>
      <p id="measured"></p>
    </div>

    <div id="step2" style="display: none">
      <p>
        Make an angry face. Yes I can see you. You are angry by this engagement
        aren't you? You are angry bc of my surveillance...
      </p>
      <div id="currentEmotionMessage">
        Your current emotion is: <span id="currentEmotion"></span>
      </div>
      <video id="video" width="600" height="450" autoplay></video>
      <script defer src="face-api.min.js"></script>
    </div>

    <div id="step3" style="display: none">
      <p>Whisper a small secret to me. I won't keep it (that's true)</p>
      <button id="recordSecret" onclick="startRecording()">
        Start Recording
      </button>
      <button
        id="stopRecording"
        style="display: none"
        onclick="stopRecording()"
      >
        Stop Recording
      </button>
      <button id="submitSecret" style="display: none" onclick="submitSecret()">
        Submit
      </button>
    </div>

    <div id="step4" style="display: none">
      <div id="pre4" style="display: block">
        <p>eat this:</p>
        <img
          id="imageButton"
          src="cake1.png"
          alt="Image Button"
          onclick="step4()"
        />
      </div>
      <div id="post4" style="display: none">
        <p id="woreOff" style="display: none">
          it wore off. you're fine now. did you like the cake?
        </p>
        <button id="nextStep5" style="display: none" onclick="takeMeToStep5()">
          Yes I loved it.
        </button>
        <p id="laced">IT WAS LACED!!!</p>
      </div>
    </div>

    <div id="step5" style="display: none">
      <!-- text box submission, must match "i love you"-->
      <p>tell me that you love me</p>
      <input type="text" id="loveInput" />
      <button onclick="checkLove()">Check</button>
      <p id="negativeLove" style="display: none">
        EWWWWW omg...jk I already knew that baby!
      </p>
      <p id="positiveLove" style="display: none">
        try again idiot. tell me that you love me!!
      </p>
    </div>

    <div id="step6" style="display: none">
      <button id="affirmationButton" onclick="downloadAffirmation()">
        take a random affirmation
      </button>
      <button
        id="internalizedButton"
        style="display: none"
        onclick="lastStep()"
      >
        I have internalized the good words.
      </button>
    </div>

    <div id="unlockedImage">
      <img style="width: 40%" src="selfie.png" alt="Unlocked Image" />
    </div>

    <script>
      var clickCount = 0;
      var seconds = 0;

      function startButton() {
        var button = document.getElementById("startButton");
        clickCount++;
        if (clickCount === 1) {
          document.getElementById("startButton").innerText = "Let's begin";
        } else if (clickCount === 2) {
          document.getElementById("startButton").style.display = "none";
          document.getElementById("step1").style.display = "block";
          timerInterval = setInterval(function () {
            seconds++;
          }, 1000);
        }
      }

      function step1() {
        if (seconds < 30) {
          document.body.style.backgroundColor = "red";
          setTimeout(function () {
            document.body.style.backgroundColor = "white";
          }, 150);
        }
        if (seconds > 30) {
          document.getElementById("measured").innerText =
            "It has actually been " + seconds + " seconds";
          document.getElementById("measured").style.display = "block";

          setTimeout(function () {
            document.getElementById("step1").style.display = "none";
            document.getElementById("step2").style.display = "block";
            startVideoAndDetection();
          }, 2500);
        }
      }

      function step4() {
        document.getElementById("pre4").style.display = "none";
        var post4 = document.getElementById("post4");
        post4.style.display = "block";
        if ((post4.style.display = "block")) {
          setTimeout(function () {
            document.body.style.backgroundImage = "url('giphy.gif')";
            document.body.style.backgroundColor = "rgba(255,255,255,0.6)";
            document.body.style.backgroundRepeat = "repeat-y";
            document.body.style.backgroundSize = "cover";
            document.querySelector("h1").style.display = "none";
            document.querySelector("h2").style.display = "none";
          }, 150);

          let audioElement = new Audio("trippy.mp3");
          audioElement.currentTime = 22;
          audioElement.play();
          setTimeout(() => audioElement.pause(), 5000);

          setTimeout(function () {
            document.body.style.backgroundImage = "none";
            document.querySelector("h1").style.display = "block";
            document.querySelector("h2").style.display = "block";
            document.getElementById("woreOff").style.display = "block";
            document.getElementById("nextStep5").style.display = "block";
          }, 5000);
        }
      }
      function takeMeToStep5() {
        document.getElementById("step4").style.display = "none";
        document.getElementById("step5").style.display = "block";
      }
      function checkLove() {
        var userInput = document
          .getElementById("loveInput")
          .value.toLowerCase();
        if (userInput === "i love you") {
          document.getElementById("positiveLove").style.display = "none";
          document.getElementById("negativeLove").style.display = "block";

          setTimeout(function () {
            document.getElementById("step5").style.display = "none";
            document.getElementById("step6").style.display = "block";
          }, 1000);
        } else {
          document.getElementById("positiveLove").style.display = "block";
          document.getElementById("negativeLove").style.display = "none";

          document.body.style.backgroundColor = "red";
          setTimeout(function () {
            document.body.style.backgroundColor = "white";
          }, 150);
        }
      }

      const affirmationImages = [
        "aff1.png",
        "aff2.png",
        "aff3.png",
        "aff4.png",
        "aff5.png",
      ];

      function downloadAffirmation() {
        const randomIndex = Math.floor(
          Math.random() * affirmationImages.length
        );
        const downloadLink = document.createElement("a");
        downloadLink.href = affirmationImages[randomIndex];
        downloadLink.download = "affirmation.jpg";
        downloadLink.click();
        document.getElementById("affirmationButton").style.display = "none";
        document.getElementById("internalizedButton").style.display = "block";
      }
      function lastStep() {
        document.getElementById("step6").style.display = "none";
        document.querySelector("h1").innerText = "You unlocked my selfie!";
        document.querySelector("h2").style.display = "none";
        document.getElementById("unlockedImage").style.display = "block";
      }

      let mediaRecorder;
      let chunks = [];

      function startRecording() {
        navigator.mediaDevices
          .getUserMedia({ audio: true })
          .then(function (stream) {
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = function (e) {
              if (e.data.size > 0) {
                chunks.push(e.data);
              }
            };

            mediaRecorder.onstop = function () {
              let blob = new Blob(chunks, { type: "audio/wav" });
              let url = URL.createObjectURL(blob);
              // Assign the recording to a variable named "secret"
              window.secret = url;

              // Display additional buttons after recording is stopped
              document.getElementById("stopRecording").style.display = "none";
              document.getElementById("submitSecret").style.display =
                "inline-block";
            };

            mediaRecorder.start();

            // Display stop recording button
            document.getElementById("recordSecret").style.display = "none";
            document.getElementById("stopRecording").style.display =
              "inline-block";
          })
          .catch(function (err) {
            console.log("Error: " + err);
          });
      }

      function stopRecording() {
        mediaRecorder.stop();
      }

      function submitSecret() {
        let audioElement = new Audio(window.secret);
        audioElement.play();
        audioElement.addEventListener("ended", function () {
          document.getElementById("step3").style.display = "none";
          document.getElementById("step4").style.display = "block";
        });
      }

      let isVideoStarted = false;

      function startVideoAndDetection() {
        if (!isVideoStarted) {
          const video = document.getElementById("video");

          navigator.mediaDevices
            .getUserMedia({ video: true })
            .then((stream) => {
              video.srcObject = stream;
              video.play();

              // Wait for the stream to be ready before starting face detection
              video.addEventListener("loadeddata", () =>
                startFaceDetection(video)
              );
            })
            .catch((error) => {
              console.error("Error accessing the camera:", error);
            });

          isVideoStarted = true;
        }
      }

      function stopVideoStream() {
        const video = document.getElementById("video");

        // Stop the video stream and tracks
        const tracks = video.srcObject.getTracks();
        tracks.forEach((track) => track.stop());

        // Clear the video source to stop displaying
        video.srcObject = null;
      }

      async function startFaceDetection() {
        const video = document.getElementById("video");
        const canvas = faceapi.createCanvasFromMedia(video);
        document.body.append(canvas);
        const displaySize = { width: video.width, height: video.height };
        faceapi.matchDimensions(canvas, displaySize);

        // Load TinyFaceDetector and FaceLandmark68Net models before face detection
        await faceapi.nets.tinyFaceDetector.loadFromUri("/models");
        await faceapi.nets.faceLandmark68Net.loadFromUri("/models");
        await faceapi.nets.faceExpressionNet.loadFromUri("/models");

        setInterval(async () => {
          const detections = await faceapi
            .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceExpressions();
          const resizedDetections = faceapi.resizeResults(
            detections,
            displaySize
          );
          canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);

          const firstDetection = detections[0];

          if (firstDetection && firstDetection.expressions) {
            let happyDetected = false;

            for (const emotion in firstDetection.expressions) {
              const emotionValue = firstDetection.expressions[emotion];

              // Check if the value is between 0.8 and 1
              if (emotionValue > 0.8 && emotionValue < 1) {
                // Print the emotion name
                document.getElementById("currentEmotion").innerText = emotion;
              }
              // Check if the value is between 0.8 and 1 for happiness
              if (
                emotion === "angry" &&
                emotionValue > 0.8 &&
                emotionValue < 1
              ) {
                happyDetected = true;
                document.body.style.backgroundColor = "chartreuse";
                setTimeout(function () {
                  document.getElementById("step2").style.display = "none";
                  document.getElementById("step3").style.display = "block";
                  document.body.style.backgroundColor = "white";
                  stopVideoStream();
                }, 1000);
                break;
              }
            }
          }
        }, 100);
      }
    </script>
  </body>
</html>
